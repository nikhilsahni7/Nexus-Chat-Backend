<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #f3f3f3;
        --text-color: #333;
        --border-color: #ddd;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f2f5;
        color: var(--text-color);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .auth-container,
      .chat-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      h1,
      h2,
      h3 {
        color: var(--primary-color);
      }

      input[type="text"],
      input[type="password"],
      input[type="email"],
      textarea {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #357ae8;
      }

      #chatMessages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        padding: 10px;
        margin-bottom: 10px;
        background-color: var(--secondary-color);
      }

      .message {
        background-color: white;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .message .username {
        font-weight: bold;
        color: var(--primary-color);
      }

      .message .content {
        margin-top: 5px;
      }

      .message .timestamp {
        font-size: 0.8em;
        color: #888;
      }

      .message .actions {
        margin-top: 5px;
      }

      .message .actions button {
        font-size: 0.8em;
        padding: 5px 10px;
        margin-right: 5px;
      }

      #onlineUsers {
        margin-bottom: 20px;
      }

      #onlineUsers .user {
        display: inline-block;
        margin-right: 10px;
        background-color: var(--secondary-color);
        padding: 5px 10px;
        border-radius: 20px;
      }

      #typingIndicator {
        font-style: italic;
        color: #888;
      }

      .hidden {
        display: none;
      }

      #profileContainer {
        margin-bottom: 20px;
      }

      #userSettings {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="authContainer" class="auth-container">
        <h1>Chat Application</h1>
        <div id="loginForm">
          <h2>Login</h2>
          <input type="text" id="loginUsername" placeholder="Username" />
          <input type="password" id="loginPassword" placeholder="Password" />
          <button onclick="login()">Login</button>
        </div>
        <div id="registerForm">
          <h2>Register</h2>
          <input type="text" id="registerUsername" placeholder="Username" />
          <input type="email" id="registerEmail" placeholder="Email" />
          <input type="password" id="registerPassword" placeholder="Password" />
          <button onclick="register()">Register</button>
        </div>
      </div>

      <div id="chatContainer" class="chat-container hidden">
        <div id="profileContainer">
          <h2>Profile</h2>
          <div id="userProfile"></div>
          <button onclick="showEditProfile()">Edit Profile</button>
          <div id="editProfileForm" class="hidden">
            <input type="text" id="editUsername" placeholder="Username" />
            <input type="email" id="editEmail" placeholder="Email" />
            <input type="text" id="editBio" placeholder="Bio" />
            <input
              type="text"
              id="editProfileImage"
              placeholder="Profile Image URL"
            />
            <button onclick="updateProfile()">Update Profile</button>
          </div>
          <div id="userSettings">
            <h3>User Settings</h3>
            <label>
              <input type="checkbox" id="notificationsEnabled" /> Enable
              Notifications
            </label>
            <label>
              <input type="checkbox" id="darkModeEnabled" /> Dark Mode
            </label>
            <select id="languageSelect">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
            </select>
            <button onclick="updateSettings()">Update Settings</button>
          </div>
        </div>

        <h2>Chat</h2>
        <div id="onlineUsers"></div>
        <div id="conversations">
          <h3>Conversations</h3>
          <button onclick="createConversation()">
            Create New Conversation
          </button>
          <div id="conversationList"></div>
          <div id="joinConversation">
            <input
              type="number"
              id="joinConversationInput"
              placeholder="Conversation ID"
            />
            <button onclick="joinConversationById()">Join Conversation</button>
          </div>
        </div>
        <div id="chatMessages"></div>
        <div id="typingIndicator"></div>
        <textarea
          id="messageInput"
          placeholder="Type your message..."
        ></textarea>
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";
      let socket;
      let currentUser;
      let currentConversationId;
      let typingTimeout;

      function login() {
        const username = document.getElementById("loginUsername").value;
        const password = document.getElementById("loginPassword").value;

        fetch(`${API_URL}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.accessToken) {
              localStorage.setItem("token", data.accessToken);
              showChatInterface();
              connectSocket();
              fetchProfile();
              fetchConversations();
              fetchOnlineUsers();
            } else {
              alert("Login failed: " + data.error);
            }
          })
          .catch((error) => {
            console.error("Login error:", error);
            alert("Login failed. Please try again.");
          });
      }

      function register() {
        const username = document.getElementById("registerUsername").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        fetch(`${API_URL}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.userId) {
              alert("Registration successful. Please login.");
            } else {
              alert("Registration failed: " + data.error);
            }
          });
      }

      function showChatInterface() {
        document.getElementById("authContainer").classList.add("hidden");
        document.getElementById("chatContainer").classList.remove("hidden");
      }

      function connectSocket() {
        socket = io(API_URL, {
          auth: {
            token: localStorage.getItem("token"),
          },
        });

        socket.on("newMessage", (message) => {
          if (message.conversationId === currentConversationId) {
            displayMessage(message);
          }
        });

        socket.on("messageUpdated", (message) => {
          if (message.conversationId === currentConversationId) {
            updateMessage(message);
          }
        });

        socket.on("messageReactionUpdate", (data) => {
          if (data.messageId) {
            updateMessageReactions(data.messageId, data.reactions);
          }
        });

        socket.on("typingUpdate", (data) => {
          if (data.conversationId === currentConversationId) {
            updateTypingIndicator(data.typingUsers);
          }
        });

        socket.on("presenceUpdate", (data) => {
          updateUserPresence(data.userId, data.status);
        });

        socket.on("newConversation", (conversation) => {
          addConversationToList(conversation);
        });
      }

      function fetchProfile() {
        fetch(`${API_URL}/profile`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        })
          .then((response) => response.json())
          .then((user) => {
            currentUser = user;
            displayProfile(user);
          });
      }

      function displayProfile(user) {
        const profileContainer = document.getElementById("userProfile");
        profileContainer.innerHTML = `
          <p><strong>Username:</strong> ${user.username}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Bio:</strong> ${user.bio || "No bio set"}</p>
          <img src="${
            user.profileImage || "https://via.placeholder.com/150"
          }" alt="Profile Image" width="150">
        `;

        // Set user settings
        document.getElementById("notificationsEnabled").checked =
          user.settings.notificationsEnabled;
        document.getElementById("darkModeEnabled").checked =
          user.settings.darkModeEnabled;
        document.getElementById("languageSelect").value =
          user.settings.language;
      }

      function showEditProfile() {
        document.getElementById("editProfileForm").classList.remove("hidden");
        document.getElementById("editUsername").value = currentUser.username;
        document.getElementById("editEmail").value = currentUser.email;
        document.getElementById("editBio").value = currentUser.bio || "";
        document.getElementById("editProfileImage").value =
          currentUser.profileImage || "";
      }

      function updateProfile() {
        const updatedProfile = {
          username: document.getElementById("editUsername").value,
          email: document.getElementById("editEmail").value,
          bio: document.getElementById("editBio").value,
          profileImage: document.getElementById("editProfileImage").value,
        };

        fetch(`${API_URL}/profile`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify(updatedProfile),
        })
          .then((response) => response.json())
          .then((user) => {
            currentUser = user;
            displayProfile(user);
            document.getElementById("editProfileForm").classList.add("hidden");
          });
      }

      function updateSettings() {
        const updatedSettings = {
          notificationsEnabled: document.getElementById("notificationsEnabled")
            .checked,
          darkModeEnabled: document.getElementById("darkModeEnabled").checked,
          language: document.getElementById("languageSelect").value,
        };

        fetch(`${API_URL}/profile/settings`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify(updatedSettings),
        })
          .then((response) => response.json())
          .then((settings) => {
            currentUser.settings = settings;
            alert("Settings updated successfully");
          });
      }

      function fetchConversations() {
        fetch(`${API_URL}/conversations`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        })
          .then((response) => response.json())
          .then((conversations) => {
            const conversationList =
              document.getElementById("conversationList");
            conversationList.innerHTML = "";
            conversations.forEach((conv) => {
              const convElement = document.createElement("div");
              convElement.textContent = `${conv.name || "Unnamed"} (ID: ${
                conv.id
              })`;
              convElement.onclick = () => joinConversation(conv.id);
              conversationList.appendChild(convElement);
            });
          });
      }

      function joinConversation(conversationId) {
        if (!conversationId) {
          alert("Invalid conversation ID");
          return;
        }
        currentConversationId = conversationId;
        socket.emit("joinConversations", [conversationId]);
        fetchMessages(conversationId);
        document.querySelector("#typingIndicator").textContent = "";
      }

      function fetchMessages(conversationId) {
        if (!conversationId) {
          console.error("Invalid conversation ID");
          return;
        }
        fetch(`${API_URL}/messages/${conversationId}`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        })
          .then((response) => response.json())
          .then((messages) => {
            const chatMessages = document.getElementById("chatMessages");
            chatMessages.innerHTML = "";
            messages.forEach(displayMessage);
          })
          .catch((error) => {
            console.error("Error fetching messages:", error);
          });
      }

      // Update the joinConversationByNameOrId function to only use ID
      function joinConversationById() {
        const input = document.getElementById("joinConversationInput").value;
        if (!input) return;

        const conversationId = parseInt(input, 10);
        if (isNaN(conversationId)) {
          alert("Please enter a valid conversation ID");
          return;
        }

        joinConversation(conversationId);
      }
      function addConversationToList(conv) {
        const conversationList = document.getElementById("conversationList");
        const convElement = document.createElement("div");
        convElement.textContent = conv.name || `Conversation ${conv.id}`;
        convElement.onclick = () => joinConversation(conv.id | 1);
        conversationList.appendChild(convElement);
      }

      function createConversation() {
        const name = prompt("Enter conversation name:");
        const participantUsernames = prompt(
          "Enter participant usernames (comma-separated):"
        );
        if (name && participantUsernames) {
          const participantIds = participantUsernames
            .split(",")
            .map((username) => username.trim());
          fetch(`${API_URL}/conversations`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({
              name,
              isGroup: participantIds.length > 1,
              participantIds,
            }),
          })
            .then((response) => response.json())
            .then((conversation) => {
              addConversationToList(conversation);
              joinConversation(conversation.id);
            });
        }
      }

      function displayMessage(message) {
        const chatMessages = document.getElementById("chatMessages");
        const messageElement = document.createElement("div");
        messageElement.className = "message";
        messageElement.id = `message-${message.id}`;
        messageElement.innerHTML = `
          <div class="username">${message.sender.username}</div>
          <div class="content">${message.content}</div>
          <div class="timestamp">${new Date(
            message.timestamp
          ).toLocaleString()}</div>
          <div class="actions">
            <button onclick="editMessage(${message.id})">Edit</button>
            <button onclick="deleteMessage(${message.id})">Delete</button>
            <button onclick="reactToMessage(${message.id}, '👍')">👍</button>
            <button onclick="reactToMessage(${message.id}, '❤️')">❤️</button>
          </div>
          <div class="reactions"></div>
        `;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        updateMessageReactions(message.id, message.reactions);
      }

      function sendMessage() {
        const content = document.getElementById("messageInput").value;
        if (!content.trim()) return;

        socket.emit("sendMessage", {
          conversationId: currentConversationId,
          content,
          contentType: "TEXT",
        });
        document.getElementById("messageInput").value = "";
      }

      function editMessage(messageId) {
        const messageElement = document.getElementById(`message-${messageId}`);
        const contentElement = messageElement.querySelector(".content");
        const newContent = prompt("Edit message:", contentElement.textContent);
        if (newContent && newContent !== contentElement.textContent) {
          socket.emit("editMessage", { messageId, newContent });
        }
      }

      function deleteMessage(messageId) {
        if (confirm("Are you sure you want to delete this message?")) {
          socket.emit("deleteMessage", { messageId });
        }
      }

      function updateMessage(message) {
        const messageElement = document.getElementById(`message-${message.id}`);
        if (messageElement) {
          messageElement.querySelector(".content").textContent =
            message.content;
          messageElement.querySelector(".timestamp").textContent = new Date(
            message.updatedAt
          ).toLocaleString();
        }
      }

      function reactToMessage(messageId, reaction) {
        socket.emit("reactToMessage", { messageId, reaction });
      }

      function updateMessageReactions(messageId, reactions) {
        const messageElement = document.getElementById(`message-${messageId}`);
        if (messageElement) {
          const reactionsElement = messageElement.querySelector(".reactions");
          reactionsElement.innerHTML = "";
          for (const [reaction, users] of Object.entries(reactions)) {
            reactionsElement.innerHTML += `${reaction} (${users.length}) `;
          }
        }
      }

      function fetchOnlineUsers() {
        fetch(`${API_URL}/users/online`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("token")}` },
        })
          .then((response) => response.json())
          .then((users) => {
            const onlineUsersElement = document.getElementById("onlineUsers");
            onlineUsersElement.innerHTML = "<h3>Online Users</h3>";
            users.forEach((user) => {
              const userElement = document.createElement("div");
              userElement.className = "user";
              userElement.textContent = user.username;
              onlineUsersElement.appendChild(userElement);
            });
          });
      }

      document.getElementById("messageInput").addEventListener("input", () => {
        if (typingTimeout) {
          clearTimeout(typingTimeout);
        }
        socket.emit("typing", {
          conversationId: currentConversationId,
          isTyping: true,
        });
        typingTimeout = setTimeout(() => {
          socket.emit("typing", {
            conversationId: currentConversationId,
            isTyping: false,
          });
        }, 2000);
      });

      function updateTypingIndicator(typingUsers) {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingUsers.length > 0) {
          typingIndicator.textContent = `${typingUsers
            .map((user) => user.username)
            .join(", ")} is typing...`;
        } else {
          typingIndicator.textContent = "";
        }
      }

      function updateUserPresence(userId, status) {
        const onlineUsersElement = document.getElementById("onlineUsers");
        const userElement = onlineUsersElement.querySelector(
          `.user[data-user-id="${userId}"]`
        );
        if (userElement) {
          if (status === "ONLINE") {
            userElement.classList.add("online");
          } else {
            userElement.classList.remove("online");
          }
        } else if (status === "ONLINE") {
          fetchOnlineUsers();
        }
      }

      // Initialize the application
      if (localStorage.getItem("token")) {
        showChatInterface();
        connectSocket();
        fetchProfile();
        fetchConversations();
        fetchOnlineUsers();
      }
    </script>
  </body>
</html>
